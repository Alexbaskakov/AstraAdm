# Лабораторная работа №7: Введение в виртуализацию на базе KVM

## Цель лабораторной работы
Цель: Научиться создавать и управлять виртуальными машинами в среде Astra Linux.

## Задачи лабораторной работы

1. Проверка поддержки виртуализации. Установка пакетов qemu-kvm, libvirt-daemon, virt-manager.
2. Создание виртуальной сети (NAT, isolated) с помощью virt-manager или virsh.
3. Установка гостевой ОС (например, другая Astra Linux или легковесный дистрибутив) из ISO-образа.
4. Управление ВМ через virsh (запуск, остановка, просмотр состояния, редактирование конфигурации).
5. Настройка проброса портов для доступа к сервисам на гостевой ОС.

---

# Теоретическая часть

## 1. Подсистема виртуализации KVM

KVM (Kernel-based Virtual Machine) — встроенная в ядро Linux технология полной виртуализации.  
Она позволяет запускать полноценные гостевые операционные системы, используя аппаратные возможности процессора — VT-x (Intel) или AMD-V (AMD).

В Astra Linux KVM интегрирован через инструменты:
- **qemu-kvm** — основной пакет для виртуализации,
- **libvirt** — сбиблиотека для управления виртуальными машинами,
- **virt-manager** — графический интерфейс для управления виртуальными машинами,
- **virsh** — CLI для полной автоматизации.

---

## 2. Проверка поддержки виртуализации
Аппаратная виртуализация должна быть включена в BIOS/UEFI.

Проверка в Linux:
```bash
lscpu | grep Virtualization
```

Если вывод содержит:
```bash
Virtualization: VT-x        (Intel)
Virtualization: AMD-V       (AMD)
```
- поддержка есть.

## 3. Установка пакетов 

```bash
sudo apt update
sudo apt install -y qemu-kvm libvirt0 virt-manager bridge-utils
```
После установки рекомендуется перезагрузить систему:
```bash
sudo reboot
```
Добавить пользователя в группы libvirt, kvm, libvirt-qemu и libvirt-admin, чтобы запускать команды управления виртуализацией без использования sudo и обеспечить полный доступ к управлению виртуальными машинами:
```bash
sudo gpasswd libvirt -a suser 
sudo gpasswd kvm -a suser
sudo gpasswd libvirt-qemu -a suser
sudo gpasswd libvirt-admin -a suser
```
В данной команде suser - это имя суперпользователя. Необходимо ввести имя своего пользователя.

Создать папку для хранения ISO-образов операционных систем, которые будут использоваться для установки виртуальных машин.
```bash
sudo mkdir /iso
```
Перенести установочный образ сервера в каталог для хранения ISO-образов.
```bash
sudo mv установочный_образ_сервера.iso /iso
```
Изменить владельца файла образа, чтобы его можно было использовать для создания виртуальной машины.
```bash
sudo chown libvirt-qemu:libvirt /iso/установочный_образ_сервера.iso
```
## 4. Создание виртуальной сети с помощью virt-manager 

Создать изолированную (isolated) или NAT-сеть можно с помощью virt-manager или virsh. 
Для этого в "virt-manager" нужно перейти в "Edit" -> "Connection details" -> "Virtual Networks" и добавить новую сеть, выбрав нужный тип. 
С помощью "virsh" можно создать сеть, используя XML-файл с соответствующей конфигурацией и команду virsh net-define. 

Создание сети в virt-manager выполняется следующим образом:
1. Запустить утилиту virt-manager, например с использованием графического интерфейса: **Меню "Пуск" – Системные — Менеджер виртуальных машин**.
2. В окне утилиты virt-manager выбрать подключение к нужному серверу виртуализации (по умолчанию QEMU/KVM), а затем выбрать пункт меню **Правка — Свойства подключения**.
<img width="560" height="562" alt="image" src="https://github.com/user-attachments/assets/e4497822-3ef8-4694-95de-21e62934dc1d" />

3. В открывшемся окне **Свойства соединения** открыть вкладку **Виртуальные сети** и нажать кнопку **+**.
<img width="813" height="634" alt="image" src="https://github.com/user-attachments/assets/7565e683-366a-4d7a-a186-4994634a68b4" />

4. В открывшемся окне **Создание виртуальной сети**:
   - в поле **Имя сети** задать наименование виртуальной сети, например virbr1;
   - в поле **Сеть** задать следующие параметры сети: 172.16.1.0/24;
   - снять флаг **Включить DHCPv4** (выключить встроенный DCHP-сервер);
   - в поле **Перенаправлять на** выбрать **Любое физическое устройство**;
   - в выпадающем списке **Режим** выбрать значение NAT;
   - нажать кнопку **Готово**.
<img width="869" height="663" alt="image" src="https://github.com/user-attachments/assets/ba7dfa9b-633b-439b-a845-a942f3fe0c29" />

5. Виртуальная сеть создана:
<img width="808" height="638" alt="image" src="https://github.com/user-attachments/assets/b0e06960-b34e-42b6-ad14-958fc2d82521" />

## 5. Создание сети с помощью virsh

1. Создайте XML-файл, описывающий конфигурацию сети, например, для изолированной сети:

```xml
<network>
  <name>isolated-net</name>
  <forward mode='nat'/>
  <bridge name='virbr0'/>
  <ip address='192.168.1.1' netmask='255.255.255.0'/>
</network>
```
2. Используйте команду virsh net-define <имя_файла>.xml для создания сети;
3. Запустите сеть командой virsh net-start <имя_сети>.

## 6. Создание виртуальной машины

Для создания гостевой машины необходимо выполнить действия, описанные ниже.

1. Запустить virt-manager.
2. В главном меню выбрать «Файл», а затем — «Создать виртуальную машину».
3. В методе установки выбрать «Локальный ISO» или «CDROM».
4. Нажать кнопку «Обзор». В левой части окна отобразятся пространства данных (по умолчанию — в каталоге /var/lib/libvirt/images). Если необходимо создать пространство данных в другой директории или на другом диске, нужно:
Нажать на значок «+» в левом нижнем углу.
5. Ввести имя для нового хранилища образов и нажать «Вперёд».
6. Указать путь до папки, где будет храниться это пространство данных, и нажать «Открыть».
7. Выбрать ранее скопированный установочный образ сервера в меню выбора тома хранилища.
8. Настроить параметры виртуальной машины: выделить необходимое количество оперативной памяти (ОЗУ) и процессоров, указать размер и расположение пространства данных.
9. После настройки системы рекомендуется проверить конфигурацию — нажать на флажок «Проверить конфигурацию».
10. Для корректной работы мыши в виртуальной машине добавить оборудование: перейти в раздел «Ввод» и выбрать «Графический планшет USB EvTouch».
11. Для начала установки нажать кнопку «Начать установку» в верхнем левом углу. В появившемся окне будет предложено активировать дефолтную сеть — нажать «ДА», и начнётся установка операционной системы.

## 7. Управление ВМ через virsh

Список основных команд для управления виртуальными машинами:

```bash
virsh list --all # просмотр всех ВМ
virsh start vm1 # запуск ВМ
virsh shutdown vm1 # выключение ВМ (штатное)
virsh destroy vm1 # принудительное завершение работы
virsh edit vm1 # редактирование конфигурации
```
Дополнительные команды:

```bash
virsh reboot vm1 # перезагрузка ВМ
virsh console vm1 # открытие консоли ВМ
virsh undefine vm1 # удаление ВМ (описания)
virsh vcpuinfo vm1 # просмотр информации о виртуальных CPU
```

## 8. Проброс портов

Для открытия XML-конфигурации NAT-сети выполнить: 
```bash
virsh net-edit default
```
Добавить:
```xml
<port redirection='yes'>
  <redirect hostport='2222' guestport='22' protocol='tcp'/>
</port>
```
Применить изменения:

```bash
virsh net-destroy default
virsh net-start default
```
Проверить проброс:

```bash
ssh -p 2222 user@localhost
```
---

# Практическая часть 

1. Создайте 2 виртуальные машины:
 - vm-router — два сетевых интерфейса (NAT и isolated).
 - vm-client — один интерфейс (isolated).
2. Настройте маршрутизацию:
 - включите IP-forwarding на vm-router;
 - настройте NAT, чтобы vm-client мог выходить в интернет.
3. Создайте свою виртуальную сеть (labnet):
 - через virt-manager или virsh;
 - подключите обе ВМ к этой сети.
4. Настройте проброс порта:
 - host:2222 → vm-router:22;
 - подключитесь через ssh -p 2222.
5. Поработайте с ВМ через virsh: запустить, остановить, перезагрузить, посмотреть статус.
6. Сделайте snapshot и выполните откат.

---

# Контрольные вопросы
1. Что такое KVM?  
2. Какие компоненты используются для виртуализации?  
3. Разница между NAT и isolated?  
4. Основные команды virsh?  
5. Как работает проброс портов?  
6. Что такое snapshot?

---

# Дополнительная литература
- https://libvirt.org  
- https://www.qemu.org  
- man virsh  
- man qemu-kvm  
