# Лабораторная работа №6: Автоматизация администрирования с помощью Bash и Ansible

## Цель лабораторной работы
Получить практические навыки автоматизации административных задач в Astra Linux с помощью Bash-скриптов, cron, systemd, rc.local, inotify и Ansible.

## Задачи лабораторной работы
1. Написание простого bash-скрипта для резервного копирования указанной директории.
2. Создание скрипта для мониторинга места на диске и отправки уведомления.
3. Знакомство с Ansible: установка, создание inventory-файла.
4. Написание простого Ansible Playbook для массового обновления пакетов на группе серверов.
5. Разработка Playbook для настройки единой политики (ntp, motd) на всех узлах.

---

# Теоретическая часть 

## 1. Bash как инструмент автоматизации

Bash — стандартная командная оболочка в Astra Linux и большинстве систем на основе GNU/Linux. 
Она интерпретирует команды и выполняет скрипты, позволяя автоматизировать повседневные задачи администратора. 
Скрипты на Bash часто используются в ситуациях, когда требуется выполнить последовательность команд без участия пользователя, либо обеспечить регулярное выполнение рутинных операций.

Скрипт Bash — это текстовый файл, содержащий команды, которые выполняются последовательно. В начале скрипта обычно располагается строка:

```bash
#!/bin/bash
```

Это указывает системе, какой интерпретатор должен выполнить файл.

### Основные элементы Bash-скриптов
- **Переменные:** используются для хранения данных.
  ```bash
  DATE=$(date +%F)
  ```

- **Условные конструкции:**
  ```bash
  if [ -f /etc/passwd ]; then
      echo "Файл существует"
  fi
  ```

- **Циклы:**
  ```bash
  for user in $(cut -d: -f1 /etc/passwd); do
      echo "$user"
  done
  ```

- **Функции:**
  ```bash
  backup() {
      tar -czf "$1" "$2"
  }
  ```

- **Перенаправления потоков:**
  ```bash
  ls /root > output.txt 2>&1
  ```

- **Автоматическая модификация конфигураций с помощью sed:**
  ```bash
  sed -i 's/PasswordAuthentication no/PasswordAuthentication yes/' /etc/ssh/sshd_config
  ```

Sed позволяет редактировать файлы без использования текстовых редакторов, что делает его удобным для автоматизации.

---

## 2. Механизмы автоматического запуска задач

Автоматизация в Linux строится не только на Bash, но и на механизмах, которые способны запускать скрипты в нужный момент. Astra Linux поддерживает несколько систем активации.

### 2.1. Cron — периодический запуск задач

cron — системный планировщик задач, который позволяет выполнять команды через определённые интервалы времени: минуту, час, сутки, неделю и т.п. Записи cron имеют фиксированный формат расписания.

Редактирование расписания:
```bash
crontab -e
```

Cron интерпретирует задания по следующему формату:
```
минуты  часы  день  месяц  день_недели  команда
```

Пример задания, выполняющегося ежедневно в 03:00:
```bash
0 3 * * * /usr/local/bin/backup.sh
```

Cron подходит для периодических задач: резервное копирование, очистка каталогов, отчёты, мониторинг.

---

### 2.2. Systemd: службы и таймеры

В Astra Linux systemd является основной подсистемой управления службами. Он позволяет создавать собственные сервисы, запускать их как полноценные процессы, управлять зависимостями и журналом выполнения.

**Unit-файл службы:**
```ini
[Unit]
Description=Backup script

[Service]
ExecStart=/usr/local/bin/backup.sh
```

**Unit-файл таймера:**
```ini
[Timer]
OnCalendar=daily
Persistent=true

[Install]
WantedBy=timers.target
```

Включение таймера:
```bash
sudo systemctl daemon-reload
sudo systemctl enable --now backup.timer
```

Для периодических задач используются systemd-timers. Таймеры поддерживают запуск по календарю, по задержке после загрузки, однократные и постоянные задачи. Они интегрированы с механизмом журналирования, поэтому история выполнения всегда доступна.

---

### 2.3. rc.local — выполнение задач при загрузке

Файл `/etc/rc.local` запускается автоматически при загрузке системы. Он может содержать команды, которые требуется выполнить один раз при старте системы.

Пример:
```bash
#!/bin/bash
/usr/local/bin/startup-script.sh &
exit 0
```

Используется для запуска пользовательских скриптов без создания служб.

---

### 2.4. Inotify — запуск задач при изменениях в файловой системе

Inotify — это подсистема ядра Linux, которая отслеживает изменения в файлах и каталогах в реальном времени. Она позволяет реагировать на события, такие как:
- создание файла
- удаление файла
- изменение содержимого
- изменение атрибутов
- открытие и закрытие файлов

Использование `inotifywait`:
```bash
inotifywait -m /var/log | while read dir file event; do
    echo "Изменение: $file"
done
```

Утилита inotifywait предоставляет удобный интерфейс для автоматической обработки данных, следующих за изменением файлов или каталогов.

---

## 3. Основы автоматизации с помощью Ansible

Ansible — это система управления конфигурацией, которая позволяет централизованно управлять несколькими серверами. Она работает через SSH и не требует установки агентов.

### 3.1. Установка Ansible

```bash
sudo apt update
sudo apt install ansible -y
```
Проверка:

```bash
ansible --version
```

### 3.2. Inventory-файл

Inventory — это перечень хостов, сгруппированных по ролям. Он определяет, какие серверы участвуют в развертывании. Группы позволяют выполнять задачи на выбранных узлах, например «все веб-серверы», «все базы данных» и т. п.
```ini
[servers]
192.168.1.10
192.168.1.11
```

Проверка доступности узлов:
```bash
ansible all -m ping
```

## 4. Ansible Playbook
Playbook — файл в формате YAML, содержащий набор задач, применяемых к группе серверов. Каждая задача определяет требуемое состояние, а Ansible последовательно приводит систему в соответствие.

Пример массового обновления пакетов (update.yml):
```yaml
- hosts: servers
  become: yes
  tasks:
    - name: Update APT cache
      apt:
        update_cache: yes

    - name: Upgrade system
      apt:
        upgrade: dist
```
Запуск:
```bash
ansible-playbook update.yml
```
## 5. Настройка общей политики (NTP, MOTD)

Общая политика означает, что все узлы должны получить одинаковые настройки.

1. Установка и базовая настройка NTP-клиента (chrony). 
2. Развёртывание единого приветственного сообщения (MOTD).

Пример настройки (policy.yml):

```yaml
- hosts: servers
  become: yes
  tasks:
    - name: Install chrony
      apt:
        name: chrony
        state: present

    - name: Configure MOTD
      copy:
        dest: /etc/motd
        content: |
          Система управляется Ansible.
          Несанкционированный доступ запрещён.
```
Запуск:
```bash
ansible-playbook policy.yml
```
---

# Практическая часть
1. Написать и протестировать скрипт резервного копирования.
2. Создать мониторинг дискового пространства с порогом предупреждения.
3. Настроить его автоматический запуск через: cron; systemd-timer
4. Написать скрипт, который реагирует на изменение файла или каталога через inotify.
5. Установить Ansible, подготовить inventory.
6. Запустить Playbook для обновления пакетов на нескольких узлах.
7. Развернуть политику NTP + MOTD через Playbook.

---

# Контрольные вопросы
1. Какие механизмы автоматизации существуют в Linux?
2. Отличие cron от systemd-timer?
3. Назначение sed?
4. Что такое inventory?
5. Как Ansible выполняет массовые задачи?
6. Что такое inotify?

---

# Дополнительная литература
1. Bash Guide for Beginners
2. man systemd.service, man systemd.timer
3. Документация ansible.com
4. inotify-tools manual
