# Лабораторная работа №2: Управление файловыми системами с использованием LVM

## Цель
Овладеть навыками управления Logical Volume Manager (LVM) для администрирования дисковых пространств в Astra Linux.

## Задачи
1. Создать физические тома, группы томов и логические тома с использованием инструментов LVM.  
2. Настроить и подключить файловую систему ext4 на логических томах, оптимизировав параметры монтирования.  
3. Изменить размер логических томов и файловых систем.  
4. Создать и управлять моментальными снимками LVM для резервного копирования.  
5. Настроить зашифрованный логический том с использованием LUKS и обеспечить его автоматическое подключение.

## Ожидаемые результаты
Изучение методов конфигурирования LVM в Astra Linux, включая создание и управление томами, изменение размеров, создание снимков и шифрование, а также документировать процессы для профессионального администрирования.

### Обзор LVM в Astra Linux
Logical Volume Manager (LVM) представляет собой мощный механизм управления дисковым пространством в операционных системах на базе Linux, включая Astra. Он позволяет абстрагировать физические диски, объединяя их в виртуальные пулы, из которых создаются гибкие логические разделы. В Astra Linux, как в системе с акцентом на безопасность и стабильность, LVM особенно полезен для динамического распределения ресурсов, что упрощает задачи администрирования в защищенных средах. По сравнению с традиционными разделами диска, LVM обеспечивает возможность расширения или сжатия томов без необходимости перезагрузки системы или потери данных, минимизируя простои и повышая эффективность.

В Astra Linux LVM интегрирован по умолчанию и поддерживает все стандартные функции, включая интеграцию с механизмами защиты, такими как шифрование. Это делает его подходящим для сценариев, где требуется быстрая адаптация к изменяющимся потребностям в хранилище, например, при установке обновлений или создании резервных копий.

### Компоненты LVM
Система LVM строится на трех основных уровнях:
- **Физический том (Physical Volume, PV)**: Это базовая единица — весь диск или отдельный раздел, подготовленный для использования в LVM. Инициализация PV осуществляется командой `pvcreate`, которая добавляет метку LVM и делает устройство доступным для дальнейшего объединения.
- **Группа томов (Volume Group, VG)**: Объединение одного или нескольких PV в единый пул ресурсов. VG распределяет пространство по блокам (экстентам), что позволяет гибко выделять место. Создание VG выполняется с помощью `vgcreate`, а расширение — `vgextend` при добавлении новых PV.
- **Логический том (Logical Volume, LV)**: Виртуальный раздел, выделяемый из VG. LV может быть отформатирован в любую файловую систему и использован как обычный диск. Команда `lvcreate` создает LV, указывая размер и имя.

Просмотр информации о компонентах осуществляется командами `pvdisplay`, `vgdisplay` и `lvdisplay`, которые выводят детальные сведения о размерах, использовании и статусе. Удаление элементов требует осторожности: сначала размонтировать LV (`umount`), затем удалить его (`lvremove`), VG (`vgremove`) и PV (`pvremove`) (каждая команда в качестве аргумента принимает идентификатор lvm хранилища).

### Создание и управление LVM
Процесс настройки LVM начинается с подготовки дисков. Например, для нового диска `/dev/sdb` последовательность команд может выглядеть так:
- `pvcreate /dev/sdb` — инициализация PV, где /dev/sdb это идентификатор диска.
- `vgcreate myvg /dev/sdb` — создание VG.
- `lvcreate -L 10G -n mylv myvg` — создание LV размером 10 ГБ.

В Astra Linux рекомендуется использовать LVM при установке ОС для облегчения откатов и обновлений. Если система уже установлена на LVM, управление осуществляется через стандартные утилиты. Важно мониторить свободное пространство в VG с помощью `vgs` или `vgdisplay`, чтобы избежать исчерпания ресурсов.

### Файловые системы и монтирование
После создания LV на него наносится файловая система, чаще всего ext4, с помощью `mkfs.ext4 /dev/myvg/mylv`. Монтирование выполняется командой `mount /dev/myvg/mylv /mnt/point`, где `/mnt/point` — точка монтирования. Для постоянного подключения добавляется запись в `/etc/fstab`, например: `/dev/myvg/mylv /mnt/point ext4 defaults 0 2`. Параметры монтирования, такие как `noatime` для снижения нагрузки или `acl` для поддержки списков доступа, позволяют оптимизировать производительность и безопасность в Astra Linux.

### Изменение размеров томов
Одно из ключевых преимуществ LVM — динамическое изменение размеров. Для расширения LV:
- `lvextend -L +5G /dev/myvg/mylv` — увеличение на 5 ГБ.
- `resize2fs /dev/myvg/mylv` — расширение файловой системы ext4.

Для сжатия сначала уменьшается файловая система (`resize2fs /dev/myvg/mylv 5G`), затем LV (`lvreduce -L 5G /dev/myvg/mylv`). Перед такими операциями обязательно создайте резервную копию данных, так как ошибки могут привести к потере информации. В Astra Linux эти операции поддерживаются в реальном времени, но требуют размонтирования для сжатия.

### Моментальные снимки (Snapshots)
Снимки позволяют фиксировать состояние LV в определенный момент, что идеально для резервного копирования. Создание снимка: `lvcreate -L 2G -s -n mysnap /dev/myvg/mylv`. Снимок хранит только изменения, экономя пространство. Его можно монтировать отдельно (`mount /dev/myvg/mysnap /mnt/snap`) для доступа к данным. Удаление снимка: `lvremove /dev/myvg/mysnap`. В Astra Linux снимки полезны для тестирования обновлений или восстановления после сбоев, интегрируясь с системами резервного копирования.

### Шифрование с LUKS
Для повышения безопасности в Astra Linux LV можно зашифровать с помощью Linux Unified Key Setup (LUKS). Процесс:
- `cryptsetup luksFormat /dev/myvg/mylv` — форматирование с паролем.
- `cryptsetup luksOpen /dev/myvg/mylv encrypted` — открытие зашифрованного устройства.
- `mkfs.ext4 /dev/mapper/encrypted` — создание файловой системы.

Автоматическое монтирование настраивается в `/etc/crypttab` (например: `encrypted UUID=... none luks`) и `/etc/fstab` (`/dev/mapper/encrypted /mnt/point ext4 defaults 0 2`). Это обеспечивает защиту данных в покое, что критично для конфиденциальной информации в защищенных системах Astra Linux.

### Лучшие практики и риски
При работе с LVM в Astra Linux рекомендуется:
- Регулярно мониторить состояние с помощью `lvs`, `vgs`, `pvs`.
- Избегать размещения загрузочного раздела `/boot` в LVM.
- Тестировать операции на виртуальных машинах перед применением в производстве.

Риски включают потерю данных при неправильном сжатии или удалении томов, поэтому всегда используйте резервные копии. В контексте Astra Linux LVM совместим с механизмами безопасности, такими как мандатный контроль доступа, обеспечивая комплексную защиту.

## Практическое задание
Выполните настройку LVM в виртуальной машине с Astra Linux Community Edition. Следуйте поэтапным инструкциям, вводя команды в консоль. Перед началом убедитесь, что система обновлена (`sudo apt update && sudo apt upgrade -y`) и установлены необходимые пакеты (`sudo apt install lvm2 cryptsetup -y`).

1. **Добавление второго жесткого диска в VirtualBox**:
   - Выключите виртуальную машину.
   - В настройках VirtualBox выберите вкладку "Носители" (Storage).
   - Добавьте новый контроллер SATA, если его нет, или присоедините к существующему.
   - Создайте новый виртуальный жесткий диск (VHD или VDI), размером не менее 20 ГБ.
   - Запустите виртуальную машину и проверьте наличие нового диска командой `lsblk` или `fdisk -l`. Диск должен отобразиться как `/dev/sdb` (или аналогичный).

2. **Создание физического тома (PV)**:
   - Инициализируйте диск как PV: `sudo pvcreate /dev/sdb`.
   - Проверьте создание: `sudo pvdisplay`.

3. **Создание группы томов (VG)**:
   - Создайте VG: `sudo vgcreate lab_vg /dev/sdb`.
   - Проверьте: `sudo vgdisplay`.

4. **Создание логического тома (LV)**:
   - Создайте LV размером 10 ГБ: `sudo lvcreate -L 10G -n lab_lv lab_vg`.
   - Проверьте: `sudo lvdisplay`.

5. **Настройка файловой системы ext4 и монтирование**:
   - Отформатируйте LV: `sudo mkfs.ext4 /dev/lab_vg/lab_lv`.
   - Создайте точку монтирования: `sudo mkdir /mnt/lab_lv`.
   - Монтируйте: `sudo mount /dev/lab_vg/lab_lv /mnt/lab_lv`.
   - Добавьте запись в `/etc/fstab` для автоматического монтирования: `sudo nano /etc/fstab`, добавьте строку `/dev/lab_vg/lab_lv /mnt/lab_lv ext4 defaults 0 2`.
   - Проверьте монтирование: `df -h`.

6. **Изменение размера логического тома**:
   - Расширьте LV на 5 ГБ: `sudo lvextend -L +5G /dev/lab_vg/lab_lv`.
   - Расширьте файловую систему: `sudo resize2fs /dev/lab_vg/lab_lv`.
   - Проверьте новый размер: `df -h /mnt/lab_lv`.

7. **Создание и управление моментальными снимками**:
   - Создайте снимок: `sudo lvcreate -L 2G -s -n lab_snap /dev/lab_vg/lab_lv`.
   - Монтируйте снимок: `sudo mkdir /mnt/lab_snap; sudo mount /dev/lab_vg/lab_snap /mnt/lab_snap`.
   - Создайте тестовый файл в оригинальном томе: `sudo touch /mnt/lab_lv/testfile`.
   - Проверьте наличие файла в снимке (он не должен измениться после создания снимка).
   - Удалите снимок: `sudo umount /mnt/lab_snap; sudo lvremove /dev/lab_vg/lab_snap`.

8. **Настройка зашифрованного логического тома с LUKS**:
   - Создайте новый LV для шифрования: `sudo lvcreate -L 5G -n encrypted_lv lab_vg`.
   - Зашифруйте: `sudo cryptsetup luksFormat /dev/lab_vg/encrypted_lv` (укажите пароль).
   - Откройте: `sudo cryptsetup luksOpen /dev/lab_vg/encrypted_lv encrypted`.
   - Отформатируйте: `sudo mkfs.ext4 /dev/mapper/encrypted`.
   - Монтируйте: `sudo mkdir /mnt/encrypted; sudo mount /dev/mapper/encrypted /mnt/encrypted`.
   - Настройте автоматическое монтирование: Добавьте в `/etc/crypttab`: `encrypted UUID=$(sudo blkid -s UUID -o value /dev/lab_vg/encrypted_lv) none luks`.
   - Добавьте в `/etc/fstab`: `/dev/mapper/encrypted /mnt/encrypted ext4 defaults 0 2`.
   - Закройте: `sudo umount /mnt/encrypted; sudo cryptsetup luksClose encrypted`.

9. **Документирование**:
   - Запишите все выполненные команды, выводы и любые ошибки в отчет (текстовый файл). Включите скриншоты ключевых шагов, таких как вывод `lvdisplay` до и после изменений.

## Контрольные вопросы
1. Что такое LVM и какие его основные компоненты?
2. Как создать физический том и группу томов?
3. Как изменить размер логического тома и файловой системы?
4. Что такое моментальный снимок LVM и как его создать?
5. Как настроить шифрование LUKS на логическом томе? 
